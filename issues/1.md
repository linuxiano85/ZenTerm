# Event Bus M2: Pattern Precompilation & Matching Performance

## Objective
Optimize event pattern matching by introducing a precompilation step that transforms wildcard patterns (*, **) into an efficient internal representation to reduce per-emit overhead.

## Problem
Current matching walks all candidate patterns and performs segment-by-segment recursion. This is acceptable at small scale but will degrade with many registered patterns and high-frequency emits.

## Scope
- Design a Pattern struct (compiled form) storing segments enum: Literal(String) | Single | Multi.
- Precompile at subscription time; store compiled alongside original pattern.
- Replace current match_segments recursion with an iterative or small-stack algorithm using the compiled representation.
- Add benchmark comparing: baseline (current) vs precompiled matching (Criterion).
- Support early pruning by indexing first literal segment (retain current first-segment map) while also indexing wildcard-leading patterns separately.
- Maintain backward compatibility for public API (no signature changes).

## Out of Scope
- Priority / backpressure (Milestone 3).
- Typed events (separate issue).

## Acceptance Criteria
- Benchmarks show measurable reduction in matching time for large sets (≥500 patterns) and deep keys. Target ≥30% improvement median time.
- No regression (<5%) for small pattern sets (≤20).
- All existing tests pass; add new tests for edge cases: leading **, multiple ** segments (should normalize / reject), invalid patterns error out gracefully.

## Implementation Notes
- Normalize consecutive ** into a single ** at compile time.
- Reject patterns containing characters outside [A-Za-z0-9_.*]. (Security hardening)
- Consider small Vec-backed arena for segments to reduce allocations.

## Risks
- Over-complication of matching path; keep code readable.
- Allocation overhead during subscription; mitigate with reuse and small vec.

## Metrics
- Add debug-only counter for compiled patterns to ensure no leaks.

## Testing
- Unit tests for compile edge cases.
- Property test (optional) generating random patterns/keys comparing old vs new engine for equality.

## Done When
All acceptance criteria met, benchmarks committed, docs updated (README Milestone 2 section).